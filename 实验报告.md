# JW05 实验报告
## 实验目标
实现一个类似全面战争模拟器的游戏，可以在开始购买小兵并且放置，在战斗中也可以控制己方  

## 实验过程
- 1.0
  1. 利用线程刷新地图
  2. 利用线程创建新的生物，并且让生物可以随机移动
  3. 对生物的移动加锁，以保证线程安全
  4. 实现生物的移动机制，使其可以朝着玩家移动
  5. 实现生物的攻击机制，实现最简单的攻击。
- 2.0
  1. 创建一个新生物，该生物将具有发射子弹的功能
  2. 实现用线程子弹的自由移动
  3. 实现子弹的攻击判定与移动判定
  4. 实现新生物的移动与攻击判定
- 3.0
  1. 实现两队生物交战
  2. 实现利用键盘来切换控制的生物
  3. 实现鼠标点击放置生物
  4. 是线上店界面  
   
## 实验方法
- 加锁方法：
  - 对于每一个tile，都在tile文件中对put函数进行加锁，加锁持续到这一生物进入为地图。相比与在移动过程中的全程加锁，我认为只在进入tile时加锁既可以实现结果，又能起到线程安全的作用
  - 对列表的加锁则是在涉及到列表操作时，直接申请同步锁，放置列表被多个线程同时更改
  - 对攻击顺序的判定，则是通过在buAttacked函数中，将生物自身加锁。
  
### 遇到的困难及解决
1. 在进行生物被攻击方面的代码编写时，出现了死锁，通过Jconsole找到了死锁产生的原因，发现是在代码的移动判断中多加了一个申请同步锁，导致死锁，去除申请即可解决问题
2. arraylist的next函数抛出异常，发现是由于对一个列表遍历时还有其他线程在增删改该列表，对列表加锁即可解决问题
3. 对游戏增加开始，暂停功能时，需要挂起所有子进程，还要在唤醒时一一唤醒。
4. 通过研究AsciiPanel的代码，发现了如何从窗口鼠标位置转化为tile的坐标，其实就是将坐标长度，宽度除以单位长度与宽度，就可以得到了。